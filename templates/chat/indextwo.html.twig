{% extends 'chatbase.html.twig' %}

    {% block title %}Hello ChatController!
    {% endblock %}
    
    {% block body %}
        <section style="background-color: #CDC4F9;">
            <div class="container py-5">
                <div class="row">
                    <div class="col-md-12">
                        <div class="card" id="chat3" style="border-radius: 15px;">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 col-lg-5 col-xl-4 mb-4 mb-md-0">
                                        <div class="p-3">
                                          <a href="{{ path('app_blog') }}">Home</a>
                                            <div class="input-group rounded mb-3">
                                                <input type="search" class="form-control rounded heybuddie" placeholder="Search" aria-label="Search" aria-describedby="search-addon"/>
                                                <span class="input-group-text border-0" id="search-addon">
                                                    <i class="fas fa-search"></i>
                                                </span>
                                            </div>
                                            <small class="errrorgoeshere"></small>
    
                                            <div data-mdb-perfect-scrollbar-init style="position: relative; height: 400px;overflow-y: auto;">
                                                <ul class="list-unstyled mb-0 getresult">
                                                    {# am getting all liste of motivator that am following #}
                                                      <!-- loop over all motivators that am following -->
                                                    {% for followingcount in followingcounts %}
                                                    <li class="p-2 border-bottom">
                                                        <a href="{{ path('app_chat',{'id':followingcount.offuserid.id}) }}" class="d-flex justify-content-between text-muted" style="text-decoration: none;">
                                                            <div class="d-flex flex-row">
                                                                <div>
                                                                    <img src="{{ asset(followingcount.offuserid.getImagepath) }}" alt="avatar" class="d-flex align-self-center me-3" width="60">
                                                                    <span class="badge bg-success badge-dot"></span>
                                                                </div>
                                                                <div class="pt-1">
                                                                    <p class="fw-bold mb-0">{{ followingcount.offuserid.username }}</p>
                                                                    <p class="small text-muted">Hello, Are you there?</p>
                                                                </div>
                                                            </div>
                                                            <div class="pt-1">
                                                                <p class="small text-muted mb-1">Just now</p>
                                                                <span class="badge bg-danger rounded-pill float-end">3</span>
                                                            </div>
                                                        </a>
                                                    </li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-lg-7 col-xl-8 chatroom">
                                        {# here goes the template chat welcome #}
                                        {{ include('chat/chatopen.html.twig')}}
                                        {# end  #}                                       
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    {% endblock %}
    {% block javascripts %} 
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.7.7/axios.min.js"></script>
      
        <script> 
         $(document).ready(function(){
      
         //here we do the seach of motivator that am only following
          $('.heybuddie').on('keyup', function () {
            let query = $(this).val();
            
            if (query.length > 2) { // Only search if at least 3 characters
                $.ajax({
                    url: '{{ path("getmotivator") }}',
                    method: 'GET',
                    data: { query: query },
                    success: function (data) {
                        $('.getresult').html(data); 
                        $('.errrorgoeshere').html('');               
                    }
                });
            }
            else{
              $('.errrorgoeshere').html('<h3 class="text-danger" style="font-size: 12px;margin-left:0px;">sorry you are not following this motivator</h3>');      
            } 
          });
    
          // This is for the chat box when we click we have to see messages for me and particular motivator
          $('.listclicker').on('click', function (e) {
            e.preventDefault();
            // url that we want to use
            let urls=this.href;
            // this function is to extract the id from  the urls
            function getidfromurl(urls){
                let segment =urls.split("/");
                return segment.pop() || segment.pop();
            }
            // and here is the id extracted from the urls
            let id=getidfromurl(urls);
            $.ajax({
                url:urls,
                type:'POST',
                data:$(this).serialize(),
                success:function(data)
                {
                    $('.chatroom').html(data);
                }
            })			
          })
          
          //here we are chating send the message
          $('.messageme').on('submit',function (e) {
            e.preventDefault();
            $.ajax({
                url: $(this).attr('action'),
                type: 'POST',
                data: $(this).serialize(),
                success: function (data) {
                    $('.good').html(data.message);
                    $('.messageme')[0].reset(); // Reset form
                },
                error: function (xhr) {
                    let data=xhr.responseJSON;
                    if(data.status==='error'){
                        $('.error').html(data.errors);
                    }
                    
                }
            });
          })
         }) 
        </script>
       <!-- Bootstrap core JavaScript -->
      {% endblock %}
      
    